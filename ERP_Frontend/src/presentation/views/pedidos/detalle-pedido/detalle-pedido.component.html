<div class="detalle-pedido-container">
  <!-- Loading State -->
  <app-loading-spinner *ngIf="vm.isLoading()" message="Cargando pedido..."></app-loading-spinner>

  <!-- Error State -->
  <div *ngIf="vm.errorMessage() && !vm.isLoading()" class="error-state">
    <span class="error-icon">‚ö†Ô∏è</span>
    <p>{{ vm.errorMessage() }}</p>
    <button class="btn-volver" (click)="vm.volver()">
      ‚Üê Volver al Listado
    </button>
  </div>

  <!-- Pedido Detail -->
  <div *ngIf="vm.pedido() && !vm.isLoading()" class="pedido-detail">
    <!-- Header -->
    <div class="detail-header">
      <div class="header-info">
        <button class="btn-back" (click)="vm.volver()">
          ‚Üê Volver
        </button>
        <h1>üì¶ Pedido {{ vm.numeroPedido() }}</h1>
        <span class="badge" [ngClass]="vm.estadoBadgeClass()">
          {{ vm.estadoLabel() }}
        </span>
      </div>
      <div class="header-actions">
        <!-- Bot√≥n Avanzar Estado -->
        <button
          *ngIf="vm.siguienteEstado()"
          class="btn-avanzar-estado"
          (click)="vm.avanzarEstado()"
          [disabled]="vm.isCambiandoEstado()">
          {{ vm.isCambiandoEstado() ? 'Cambiando...' : '‚ñ∂ Pasar a ' + vm.siguienteEstadoLabel() }}
        </button>

        <!-- Bot√≥n Cancelar Pedido -->
        <button
          *ngIf="vm.puedeCancelar()"
          class="btn-cancelar-pedido"
          (click)="vm.cancelarPedido()"
          [disabled]="vm.isCambiandoEstado()">
          ‚úï Cancelar Pedido
        </button>

        <!-- Bot√≥n Editar (solo si est√° Pendiente) -->
        <button
          *ngIf="vm.puedeEditar()"
          class="btn-editar"
          (click)="vm.editar()">
          ‚úèÔ∏è Editar Pedido
        </button>
      </div>
    </div>

    <!-- Informaci√≥n General -->
    <div class="info-section">
      <h2 class="section-title">üìã Informaci√≥n General</h2>
      <div class="info-grid">
        <div class="info-card">
          <span class="info-label">Fecha del Pedido:</span>
          <span class="info-value">{{ vm.fechaFormateada() }}</span>
        </div>
        <div class="info-card">
          <span class="info-label">Creado por:</span>
          <span class="info-value">{{ vm.pedido()!.nombreUsuario }}</span>
        </div>
        <div class="info-card">
          <span class="info-label">Direcci√≥n de Entrega:</span>
          <span class="info-value">{{ vm.pedido()!.direccionEntrega }}</span>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n del Proveedor -->
    <div class="info-section">
      <h2 class="section-title">üè≠ Informaci√≥n del Proveedor</h2>
      <div class="proveedor-card">
        <div class="proveedor-header">
          <h3>{{ vm.nombreProveedor() }}</h3>
        </div>
      </div>
    </div>

    <!-- L√≠neas del Pedido -->
    <div class="info-section">
      <h2 class="section-title">üì¶ L√≠neas del Pedido</h2>
      <div class="lineas-table">
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th class="text-center">Cantidad</th>
              <th class="text-right">Precio Unit.</th>
              <th class="text-center">IVA %</th>
              <th class="text-right">Subtotal</th>
              <th class="text-right">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let linea of vm.pedido()!.lineasPedido">
              <td>
                <div class="producto-info">
                  <span class="producto-nombre">{{ linea.nombreProducto }}</span>
                </div>
              </td>
              <td class="text-center">{{ linea.cantidad }}</td>
              <td class="text-right">{{ linea.precioUnitario | currency:'EUR' }}</td>
              <td class="text-center">{{ linea.ivaPorcentaje }}%</td>
              <td class="text-right">{{ vm.calcularSubtotalLinea(linea.cantidad, linea.precioUnitario) | currency:'EUR' }}</td>
              <td class="text-right total-cell">{{ vm.calcularTotalLinea(linea.cantidad, linea.precioUnitario, linea.ivaPorcentaje) | currency:'EUR' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Resumen Financiero -->
    <div class="info-section">
      <h2 class="section-title">üí∞ Resumen Financiero</h2>
      <div class="resumen-card">
        <div class="resumen-row">
          <span class="resumen-label">Subtotal:</span>
          <span class="resumen-value">{{ vm.subtotal() | currency:'EUR' }}</span>
        </div>
        <div class="resumen-row">
          <span class="resumen-label">IVA Total:</span>
          <span class="resumen-value">{{ vm.totalImpuestos() | currency:'EUR' }}</span>
        </div>
        <div class="resumen-row total">
          <span class="resumen-label">TOTAL:</span>
          <span class="resumen-value">{{ vm.total() | currency:'EUR' }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
