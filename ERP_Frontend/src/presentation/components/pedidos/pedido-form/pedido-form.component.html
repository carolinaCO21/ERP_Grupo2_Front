<div class="form-container" *ngIf="vm">
  <form class="form-card">
    <!-- Info Section -->
    <div class="form-section">
      <h2 class="section-label">Informacion del Pedido</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Proveedor *</label>
          <select
            [ngModel]="vm.proveedorSeleccionado()"
            (ngModelChange)="vm.onProveedorChange($event)"
            name="proveedor"
            [disabled]="vm.modoEdicion()"
            required>
            <option [ngValue]="null">Seleccione un proveedor...</option>
            <option *ngFor="let proveedor of vm.proveedores()" [ngValue]="proveedor.id">
              {{ proveedor.nombreEmpresa }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Direccion de Entrega *</label>
        <textarea
          [ngModel]="vm.direccionEntrega()"
          (ngModelChange)="vm.direccionEntrega.set($event)"
          name="direccion"
          rows="3"
          placeholder="Ingrese la direccion completa..."
          required>
        </textarea>
      </div>
    </div>

    <!-- Lines Section -->
    <div class="form-section">
      <div class="section-header">
        <h2 class="section-label">Lineas del Pedido</h2>
        <button type="button" class="btn-add" (click)="vm.agregarLinea()" [disabled]="!vm.proveedorSeleccionado()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14"/>
            <path d="M12 5v14"/>
          </svg>
          Agregar Linea
        </button>
      </div>

      <div class="info-msg" *ngIf="!vm.proveedorSeleccionado()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 16v-4"/>
          <path d="M12 8h.01"/>
        </svg>
        Seleccione un proveedor para agregar lineas
      </div>

      <div class="lineas-list" *ngIf="vm.lineasPedido().length > 0">
        <div *ngFor="let linea of vm.lineasPedido(); let i = index; trackBy: trackByIndex" class="linea-card">
          <div class="linea-top">
            <span class="linea-num">Linea {{ i + 1 }}</span>
            <button type="button" class="btn-remove" (click)="vm.eliminarLinea(i)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            </button>
          </div>

          <div class="linea-fields">
            <div class="form-group fg-wide">
              <label>Producto *</label>
              <select
                [ngModel]="linea.idProducto"
                (ngModelChange)="vm.actualizarLinea(i, 'idProducto', $event)"
                [name]="'producto_' + i"
                required>
                <option [ngValue]="0">Seleccione un producto...</option>
                <option *ngFor="let producto of vm.productosDisponibles()" [ngValue]="producto.idProducto">
                  {{ producto.nombreProducto }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label>Cantidad *</label>
              <input type="number" [ngModel]="linea.cantidad" (ngModelChange)="vm.actualizarLinea(i, 'cantidad', $event)" [name]="'cantidad_' + i" min="1" required />
            </div>
            <div class="form-group">
              <label>Precio Unit. *</label>
              <input type="number" [ngModel]="linea.precioUnitario" (ngModelChange)="vm.actualizarLinea(i, 'precioUnitario', $event)" [name]="'precio_' + i" min="0" step="0.01" required />
            </div>
            <div class="form-group">
              <label>IVA % *</label>
              <input type="number" [ngModel]="linea.ivaPorcentaje" (ngModelChange)="vm.actualizarLinea(i, 'ivaPorcentaje', $event)" [name]="'iva_' + i" min="0" max="100" required />
            </div>
          </div>
        </div>
      </div>

      <div class="empty-msg" *ngIf="vm.lineasPedido().length === 0 && vm.proveedorSeleccionado()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
          <path d="m3.3 7 8.7 5 8.7-5"/>
          <path d="M12 22V12"/>
        </svg>
        No hay lineas. Haga clic en "Agregar Linea"
      </div>
    </div>

    <!-- Totals -->
    <div class="form-section totals-section" *ngIf="vm.lineasPedido().length > 0">
      <h2 class="section-label">Totales</h2>
      <div class="totals-card">
        <div class="total-row">
          <span>Subtotal</span>
          <span>{{ vm.subtotalPedido() | currency: 'EUR' }}</span>
        </div>
        <div class="total-row">
          <span>Impuestos (IVA)</span>
          <span>{{ vm.impuestosPedido() | currency: 'EUR' }}</span>
        </div>
        <div class="total-row total-final">
          <span>TOTAL</span>
          <span>{{ vm.totalPedido() | currency: 'EUR' }}</span>
        </div>
      </div>
    </div>

    <!-- Error -->
    <div class="error-msg" *ngIf="vm.errorMessage()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" x2="12" y1="8" y2="12"/>
        <line x1="12" x2="12.01" y1="16" y2="16"/>
      </svg>
      {{ vm.errorMessage() }}
    </div>

    <!-- Actions -->
    <div class="form-actions">
      <button type="button" class="btn btn-ghost" (click)="onCancelar()" [disabled]="vm.isLoading()">Cancelar</button>
      <button type="button" class="btn btn-primary" (click)="onGuardar()" [disabled]="vm.isLoading()">
        {{ vm.isLoading() ? 'Guardando...' : (vm.modoEdicion() ? 'Actualizar' : 'Crear Pedido') }}
      </button>
    </div>
  </form>
</div>
