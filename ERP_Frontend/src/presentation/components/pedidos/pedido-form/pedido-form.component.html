<div class="pedido-form-container">
  <form class="pedido-form" *ngIf="vm">
    <!-- Secci√≥n: Informaci√≥n del Pedido -->
    <div class="form-section">
      <h2 class="section-title">üìã Informaci√≥n del Pedido</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Proveedor *</label>
          <select
            [ngModel]="vm.proveedorSeleccionado()"
            (ngModelChange)="vm.onProveedorChange($event)"
            name="proveedor"
            [disabled]="vm.modoEdicion()"
            required>
            <option [ngValue]="null">Seleccione un proveedor...</option>
            <option *ngFor="let proveedor of vm.proveedores()" [ngValue]="proveedor.id">
              {{ proveedor.nombreEmpresa }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Direcci√≥n de Entrega *</label>
        <textarea
          [ngModel]="vm.direccionEntrega()"
          (ngModelChange)="vm.direccionEntrega.set($event)"
          name="direccion"
          rows="3"
          placeholder="Ingrese la direcci√≥n completa..."
          required>
        </textarea>
      </div>
    </div>

    <!-- Secci√≥n: L√≠neas de Pedido -->
    <div class="form-section">
      <div class="section-header">
        <h2 class="section-title">üì¶ L√≠neas del Pedido</h2>
        <button
          type="button"
          class="btn btn-add"
          (click)="vm.agregarLinea()"
          [disabled]="!vm.proveedorSeleccionado()">
          ‚ûï Agregar L√≠nea
        </button>
      </div>

      <div class="info-message" *ngIf="!vm.proveedorSeleccionado()">
        ‚ÑπÔ∏è Seleccione un proveedor para agregar l√≠neas
      </div>

      <div class="lineas-container" *ngIf="vm.lineasPedido().length > 0">
        <div *ngFor="let linea of vm.lineasPedido(); let i = index; trackBy: trackByIndex" class="linea-item">
          <div class="linea-header">
            <span class="linea-numero">L√≠nea {{ i + 1 }}</span>
            <button type="button" class="btn-remove" (click)="vm.eliminarLinea(i)">
              üóëÔ∏è Eliminar
            </button>
          </div>

          <div class="linea-fields">
            <div class="form-group">
              <label>Producto *</label>
              <select
                [ngModel]="linea.idProducto"
                (ngModelChange)="vm.actualizarLinea(i, 'idProducto', $event)"
                [name]="'producto_' + i"
                required>
                <option [ngValue]="0">Seleccione un producto...</option>
                <option *ngFor="let producto of vm.productosDisponibles()" [ngValue]="producto.idProducto">
                  {{ producto.nombreProducto }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Cantidad *</label>
              <input
                type="number"
                [ngModel]="linea.cantidad"
                (ngModelChange)="vm.actualizarLinea(i, 'cantidad', $event)"
                [name]="'cantidad_' + i"
                min="1"
                required />
            </div>

            <div class="form-group">
              <label>Precio Unitario *</label>
              <input
                type="number"
                [ngModel]="linea.precioUnitario"
                (ngModelChange)="vm.actualizarLinea(i, 'precioUnitario', $event)"
                [name]="'precio_' + i"
                min="0"
                step="0.01"
                required />
            </div>

            <div class="form-group">
              <label>IVA % *</label>
              <input
                type="number"
                [ngModel]="linea.ivaPorcentaje"
                (ngModelChange)="vm.actualizarLinea(i, 'ivaPorcentaje', $event)"
                [name]="'iva_' + i"
                min="0"
                max="100"
                required />
            </div>
          </div>
        </div>
      </div>

      <div class="empty-message" *ngIf="vm.lineasPedido().length === 0 && vm.proveedorSeleccionado()">
        üì≠ No hay l√≠neas. Haga clic en "Agregar L√≠nea"
      </div>
    </div>

    <!-- Secci√≥n: Totales -->
    <div class="form-section totales-section" *ngIf="vm.lineasPedido().length > 0">
      <h2 class="section-title">üí∞ Totales</h2>

      <div class="totales-card">
        <div class="total-row">
          <span>Subtotal:</span>
          <span>{{ vm.subtotalPedido() | currency: 'EUR' }}</span>
        </div>
        <div class="total-row">
          <span>Impuestos (IVA):</span>
          <span>{{ vm.impuestosPedido() | currency: 'EUR' }}</span>
        </div>
        <div class="total-row total-final">
          <span>TOTAL:</span>
          <span>{{ vm.totalPedido() | currency: 'EUR' }}</span>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-message" *ngIf="vm.errorMessage()">
      ‚ö†Ô∏è {{ vm.errorMessage() }}
    </div>

    <!-- Actions -->
    <div class="form-actions">
      <button type="button" class="btn btn-cancel" (click)="onCancelar()" [disabled]="vm.isLoading()">
        Cancelar
      </button>
      <button type="button" class="btn btn-save" (click)="onGuardar()" [disabled]="vm.isLoading()">
        {{ vm.isLoading() ? 'Guardando...' : (vm.modoEdicion() ? 'Actualizar' : 'Crear Pedido') }}
      </button>
    </div>
  </form>
</div>
